<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–û–±—ä—è–≤–ª–µ–Ω–∏—è</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <!-- Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- –¢–µ–º–∞ –∏ –∏–∫–æ–Ω–∫–∞ -->
  <script>
    const storedTheme = localStorage.getItem("theme");
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;

    if (storedTheme === "dark" || (!storedTheme && prefersDark)) {
      document.documentElement.classList.add("dark");
      localStorage.setItem("theme", "dark");
    } else {
      document.documentElement.classList.remove("dark");
      localStorage.setItem("theme", "light");
    }

    window.addEventListener("DOMContentLoaded", () => {
      const themeToggle = document.getElementById("themeToggle");

      function updateThemeIcon() {
        const isDark = document.documentElement.classList.contains("dark");
        themeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
      }

      updateThemeIcon();

      themeToggle.addEventListener("click", () => {
        document.documentElement.classList.toggle("dark");
        const isDark = document.documentElement.classList.contains("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        updateThemeIcon();
      });
    });
  </script>

  <!-- –°—Ç–∏–ª–∏ -->
  <style>
    body {
      background: linear-gradient(145deg, #e0e7ff, #ffffff);
    }

    .dark body {
      background: linear-gradient(145deg, #000000);
    }

    .dark .glass {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      background: #4f46e5;
      color: white;
      border-radius: 8px;
      font-weight: 600;
      animation: fadein 0.3s, fadeout 0.3s 2.7s;
      z-index: 1000;
    }

    @keyframes fadein {
      from {
        opacity: 0;
        bottom: 0;
      }

      to {
        opacity: 1;
        bottom: 20px;
      }
    }

    @keyframes fadeout {
      from {
        opacity: 1;
        bottom: 20px;
      }

      to {
        opacity: 0;
        bottom: 0;
      }
    }
  </style>
</head>

<body class="text-gray-900 dark:text-gray-100 font-sans transition-colors">
  <div id="toastContainer"></div>
  <main class="container mx-auto p-4 max-w-4xl">
    <!-- üîπ –®–∞–ø–∫–∞ -->
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">üì¢ –û–±—ä—è–≤–ª–µ–Ω–∏—è</h1>
      <div class="flex gap-2 items-center">
        <button id="themeToggle"
          class="px-3 py-2 rounded-xl bg-gray-300 dark:bg-gray-700 text-sm transition">üåô</button>
        <button id="authButton"
          class="px-4 py-2 rounded-xl bg-primary text-white font-semibold hover:bg-secondary transition">üîê
          –í–æ–π—Ç–∏</button>
        <button id="logoutButton"
          class="hidden px-4 py-2 rounded-xl bg-danger text-white font-semibold hover:bg-red-600 transition">üö™
          –í—ã–π—Ç–∏</button>
      </div>
    </header>

    <!-- üîπ –§–æ—Ä–º–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è -->
    <!-- (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –ø—Ä–æ–¥–æ–ª–∂–∞–π —Å —Ç–≤–æ–µ–≥–æ –∫–æ–¥–∞ –Ω–∏–∂–µ) -->

    <form id="adForm" class="glass p-4 rounded-xl mb-6">
      <input type="text" name="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" class="w-full p-2 rounded mb-2" required />
      <textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" class="w-full p-2 rounded mb-2" required></textarea>
      <input type="text" name="author" placeholder="–í–∞—à–µ –∏–º—è" class="w-full p-2 rounded mb-2" required />
      <select name="category" class="w-full p-2 rounded mb-2">
        <option value="–û–±—â–µ–µ">–û–±—â–µ–µ</option>
        <option value="–ü—Ä–æ–¥–∞–∂–∞">–ü—Ä–æ–¥–∞–∂–∞</option>
        <option value="–°–æ–±—ã—Ç–∏–µ">–°–æ–±—ã—Ç–∏–µ</option>
      </select>
      <input type="file" id="image" accept="image/*" class="mb-2" />
      <button type="submit"
        class="bg-primary hover:bg-secondary text-white font-semibold px-4 py-2 rounded-xl shadow transition-all duration-200 dark:shadow-lg">
        üì¢ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
      </button>
    </form>

    <!-- üîπ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è -->
    <div class="flex justify-between mb-4">
      <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫..." class="w-full p-2 border rounded" />
      <select id="sortSelect" class="ml-2 p-2 rounded">
        <option value="created">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
        <option value="title">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
      </select>
    </div>

    <!-- üîπ –°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π -->
    <section id="adsList" class="grid gap-4"></section>

    <!-- üîπ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å -->
    <section id="adminPanel" class="hidden glass p-4 rounded-xl mt-8">
      <h2 class="text-xl font-bold mb-2">üõ† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
      <p class="mb-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä!</p>
      <div class="bg-gray-100 dark:bg-gray-800 p-2 rounded overflow-auto max-h-64">
        <pre id="logOutput" class="text-sm whitespace-pre-wrap"></pre>
      </div>
    </section>
  </main>

  <!-- üîπ –°–∫—Ä–∏–ø—Ç -->
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
      const firebaseConfig = {
        apiKey: "AIzaSyA0vpiFyn1TfCNdL_yZsUpWhcEqxDFlE-o",
        authDomain: "bardovka.firebaseapp.com",
        projectId: "bardovka",
        storageBucket: "bardovka.appspot.com",
        messagingSenderId: "1187834472",
        appId: "1:1187834472:web:4a2b7d6c20e9b82c0f7d78",
        measurementId: "G-KXD60VFGD3"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();
      const storage = firebase.storage();

      const toast = document.getElementById("toast");
      const toastMessage = document.getElementById("toast-message");

      function showToast(message, type = "success") {
        toastMessage.textContent = message;
        toast.style.backgroundColor = type === "success" ? "#4caf50" : "#f44336";
        toast.style.bottom = "20px";
        setTimeout(() => {
          toast.style.bottom = "-100px";
        }, 3000);
      }

      const authButton = document.getElementById("authButton");
      const userEmailDisplay = document.getElementById("userEmail");

      authButton.addEventListener("click", async () => {
        if (auth.currentUser) {
          await auth.signOut();
          showToast("–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞");
        } else {
          const provider = new firebase.auth.GoogleAuthProvider();
          auth.signInWithPopup(provider)
            .then((result) => {
              showToast("–í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏");
            })
            .catch((error) => {
              showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ", "error");
              console.error(error);
            });
        }
      });

      auth.onAuthStateChanged((user) => {
        if (user) {
          authButton.textContent = "üö™ –í—ã–π—Ç–∏";
          userEmailDisplay.textContent = `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ${user.email}`;
        } else {
          authButton.textContent = "üîê –í–æ–π—Ç–∏";
          userEmailDisplay.textContent = "";
        }
      });

      document.getElementById("adForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log("–§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞"); // –ø—Ä–æ–≤–µ—Ä–∫–∞

        if (!auth.currentUser) {
          showToast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç", "error");
          return;
        }

        const title = document.getElementById("title").value;
        const description = document.getElementById("description").value;
        const fileInput = document.getElementById("image");
        const file = fileInput.files[0];

        const data = {
          title,
          description,
          user: auth.currentUser.email,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
          if (file) {
            const ref = storage.ref().child(`ads/${Date.now()}_${file.name}`);
            await ref.put(file);
            data.imageUrl = await ref.getDownloadURL();
          }

          await db.collection("ads").add(data);
          showToast("–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!");

          document.getElementById("adForm").reset();
        } catch (err) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã:", err);
          showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏", "error");
        }
      });
    });
  </script>
</body>

</html>
