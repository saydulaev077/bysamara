<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û–±—ä—è–≤–ª–µ–Ω–∏—è —Å –º–æ–¥–∞–ª–∫–æ–π –∏ —É–ª—É—á—à–µ–Ω–∏—è–º–∏</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <!-- Tailwind CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background: linear-gradient(145deg, #e0e7ff, #ffffff);
    }

    .dark body {
      background: linear-gradient(145deg, #000000);
    }

    .dark .glass {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100%);
      padding: 14px 24px;
      background: #4f46e5;
      color: white;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 6px 12px rgba(79, 70, 229, 0.3);
      opacity: 0;
      pointer-events: none;
      transition: all 0.4s ease;
      z-index: 1000;
      user-select: none;
    }

    .toast.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(0);
    }

    .modal-bg {
      background: rgba(0, 0, 0, 0.45);
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .modal-bg.show {
      opacity: 1;
      pointer-events: auto;
    }

    .modal {
      background: white;
      max-width: 480px;
      width: 100%;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
      color: #222;
      font-family: "Manrope", sans-serif;
    }

    .modal.dark {
      background: #111;
      color: #eee;
    }

    .modal h3 {
      margin-bottom: 16px;
      font-weight: 700;
      font-size: 1.5rem;
    }

    .modal label {
      display: block;
      margin-top: 12px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .modal input[type="text"],
    .modal textarea,
    .modal select {
      width: 100%;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
      font-family: "Manrope", sans-serif;
      resize: vertical;
    }

    .modal textarea {
      min-height: 80px;
    }

    .modal button {
      margin-top: 20px;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
      border: none;
    }

    .modal .btn-primary {
      background-color: #4f46e5;
      color: white;
    }

    .modal .btn-primary:hover {
      background-color: #4338ca;
    }

    .modal .btn-secondary {
      background-color: #ccc;
      color: #444;
      margin-left: 12px;
    }

    .modal .btn-secondary:hover {
      background-color: #aaa;
    }

    .btn-primary,
    .btn-secondary {
      user-select: none;
    }

    .dark .modal input[type="text"],
    .dark .modal textarea,
    .dark .modal select {
      background: #222;
      border-color: #444;
      color: #eee;
    }

    .dark .modal .btn-secondary {
      background-color: #444;
      color: #ddd;
    }

    .dark .modal .btn-secondary:hover {
      background-color: #666;
    }
  </style>

  <script>
    const storedTheme = localStorage.getItem("theme");
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;

    if (storedTheme === "dark" || (!storedTheme && prefersDark)) {
      document.documentElement.classList.add("dark");
      localStorage.setItem("theme", "dark");
    } else {
      document.documentElement.classList.remove("dark");
      localStorage.setItem("theme", "light");
    }

    window.addEventListener("DOMContentLoaded", () => {
      const themeToggle = document.getElementById("themeToggle");

      function updateThemeIcon() {
        const isDark = document.documentElement.classList.contains("dark");
        themeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
      }

      updateThemeIcon();

      themeToggle.addEventListener("click", () => {
        document.documentElement.classList.toggle("dark");
        const isDark = document.documentElement.classList.contains("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        updateThemeIcon();
        // –ú–æ–¥–∞–ª–∫–∞ —Ç–æ–∂–µ –º–µ–Ω—è–µ—Ç –∫–ª–∞—Å—Å
        document.querySelectorAll(".modal").forEach(modal => {
          if (isDark) modal.classList.add("dark");
          else modal.classList.remove("dark");
        });
      });
    });
  </script>
</head>

<body class="text-gray-900 dark:text-gray-100 font-sans transition-colors">
  <div id="toastContainer"></div>
  <main class="container mx-auto p-4 max-w-4xl">
    <!-- –®–∞–ø–∫–∞ -->
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">üì¢ –û–±—ä—è–≤–ª–µ–Ω–∏—è</h1>
      <div class="flex gap-2 items-center">
        <button id="themeToggle"
          class="px-3 py-2 rounded-xl bg-gray-300 dark:bg-gray-700 text-sm transition">üåô</button>
        <button id="authButton"
          class="px-4 py-2 rounded-xl bg-primary text-white font-semibold hover:bg-secondary transition">üîê –í–æ–π—Ç–∏</button>
        <button id="logoutButton"
          class="hidden px-4 py-2 rounded-xl bg-danger text-white font-semibold hover:bg-red-600 transition">üö™ –í—ã–π—Ç–∏</button>
      </div>
    </header>

    <!-- –§–æ—Ä–º–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è -->
    <form id="adForm" class="glass p-4 rounded-xl mb-6">
      <input type="text" name="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" class="w-full p-2 rounded mb-2" required />
      <textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" class="w-full p-2 rounded mb-2" required></textarea>
      <input type="text" name="author" placeholder="–í–∞—à–µ –∏–º—è" class="w-full p-2 rounded mb-2" required />
      <select name="category" class="w-full p-2 rounded mb-2">
        <option value="–û–±—â–µ–µ">–û–±—â–µ–µ</option>
        <option value="–ü—Ä–æ–¥–∞–∂–∞">–ü—Ä–æ–¥–∞–∂–∞</option>
        <option value="–°–æ–±—ã—Ç–∏–µ">–°–æ–±—ã—Ç–∏–µ</option>
      </select>
      <input type="file" id="image" accept="image/*" class="mb-2" />
      <button type="submit"
        class="bg-primary hover:bg-secondary text-white font-semibold px-4 py-2 rounded-xl shadow transition-all duration-200 dark:shadow-lg">
        üì¢ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
      </button>
    </form>

    <!-- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è -->
    <div class="flex justify-between mb-4">
      <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫..." class="w-full p-2 border rounded" />
      <select id="sortSelect" class="ml-2 p-2 rounded">
        <option value="created">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
        <option value="title">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
      </select>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π -->
    <section id="adsList" class="grid gap-4"></section>

    <!-- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å -->
    <section id="adminPanel" class="hidden glass p-4 rounded-xl mt-8">
      <h2 class="text-xl font-bold mb-2">üõ† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
      <p class="mb-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä!</p>
      <div class="bg-gray-100 dark:bg-gray-800 p-2 rounded overflow-auto max-h-64">
        <pre id="logOutput" class="text-sm whitespace-pre-wrap"></pre>
      </div>
    </section>
  </main>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <div id="modalBg" class="modal-bg" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc">
      <h3 id="modalTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h3>
      <form id="modalForm" novalidate>
        <label for="modalTitleInput">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
        <input id="modalTitleInput" name="title" type="text" required minlength="3" />

        <label for="modalDescriptionInput">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea id="modalDescriptionInput" name="description" required minlength="5"></textarea>

        <label for="modalCategorySelect">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
        <select id="modalCategorySelect" name="category" required>
          <option value="–û–±—â–µ–µ">–û–±—â–µ–µ</option>
          <option value="–ü—Ä–æ–¥–∞–∂–∞">–ü—Ä–æ–¥–∞–∂–∞</option>
          <option value="–°–æ–±—ã—Ç–∏–µ">–°–æ–±—ã—Ç–∏–µ</option>
        </select>

        <div class="flex justify-end">
          <button type="button" id="modalCancel" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn-primary ml-2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function showToast(message, type = "info") {
      const toast = document.createElement("div");
      toast.className = "toast show";
      if (type === "error") {
        toast.style.backgroundColor = "#e53e3e";
        toast.style.boxShadow = "0 6px 12px rgba(229, 62, 62, 0.3)";
      } else if (type === "success") {
        toast.style.backgroundColor = "#38a169";
        toast.style.boxShadow = "0 6px 12px rgba(56, 161, 105, 0.3)";
      }
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => {
          toast.remove();
        }, 400);
      }, 3500);
    }

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    const modalBg = document.getElementById("modalBg");
    const modalForm = document.getElementById("modalForm");
    const modalTitleInput = document.getElementById("modalTitleInput");
    const modalDescriptionInput = document.getElementById("modalDescriptionInput");
    const modalCategorySelect = document.getElementById("modalCategorySelect");
    const modalCancel = document.getElementById("modalCancel");

    let editingAdId = null;

    // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
    function openEditModal(ad) {
      editingAdId = ad.id;
      modalTitleInput.value = ad.title || "";
      modalDescriptionInput.value = ad.description || "";
      modalCategorySelect.value = ad.category || "–û–±—â–µ–µ";
      modalBg.classList.add("show");
      modalTitleInput.focus();
    }

    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
    function closeEditModal() {
      editingAdId = null;
      modalBg.classList.remove("show");
      modalForm.reset();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã
    modalCancel.addEventListener("click", () => {
      closeEditModal();
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª–∫–∏
    modalBg.addEventListener("click", e => {
      if (e.target === modalBg) {
        closeEditModal();
      }
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –º–æ–¥–∞–ª–∫–∏
    modalForm.addEventListener("submit", e => {
      e.preventDefault();

      if (!editingAdId) {
        showToast("–û—à–∏–±–∫–∞: id –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ –∑–∞–¥–∞–Ω", "error");
        return;
      }

      const newTitle = modalTitleInput.value.trim();
      const newDescription = modalDescriptionInput.value.trim();
      const newCategory = modalCategorySelect.value;

      if (newTitle.length < 3 || newDescription.length < 5) {
        showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ", "error");
        return;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Firestore
      db.collection("ads").doc(editingAdId).update({
        title: newTitle,
        description: newDescription,
        category: newCategory,
      }).then(() => {
        showToast("–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ", "success");
        logEvent(`‚úèÔ∏è –û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${editingAdId}`);
        loadAds();
        closeEditModal();
      }).catch(() => {
        showToast("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", "error");
      });
    });

    // ----------------- –í–ê–® –°–ö–†–ò–ü–¢ Firebase –∏ –ª–æ–≥–∏–∫–∞ -----------------
    // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ –∫–æ–Ω—Ñ–∏–≥–∏ Firebase
    const firebaseConfig = {
      apiKey: "–í–ê–®_API_–ö–õ–Æ–ß",
      authDomain: "–í–ê–®_AUTH_DOMAIN",
      projectId: "–í–ê–®_PROJECT_ID",
      storageBucket: "–í–ê–®_STORAGE_BUCKET",
      messagingSenderId: "–í–ê–®_SENDER_ID",
      appId: "–í–ê–®_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const authButton = document.getElementById("authButton");
    const logoutButton = document.getElementById("logoutButton");
    const adForm = document.getElementById("adForm");
    const adsList = document.getElementById("adsList");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");
    const adminPanel = document.getElementById("adminPanel");
    const logOutput = document.getElementById("logOutput");

    // –ê–¥–º–∏–Ω—ã (–ø—Ä–∏–º–µ—Ä)
    const admins = ["admin@example.com"];

    let currentUser = null;

    // –û–±–Ω–æ–≤–∏—Ç—å UI –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞
    function updateUI(user) {
      currentUser = user;
      if (user) {
        authButton.classList.add("hidden");
        logoutButton.classList.remove("hidden");
        adminPanel.classList.toggle("hidden", !admins.includes(user.email));
      } else {
        authButton.classList.remove("hidden");
        logoutButton.classList.add("hidden");
        adminPanel.classList.add("hidden");
      }
    }

    // –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
    authButton.addEventListener("click", () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(err => {
        showToast("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + err.message, "error");
      });
    });

    // –í—ã–π—Ç–∏
    logoutButton.addEventListener("click", () => {
      auth.signOut();
    });

    auth.onAuthStateChanged(user => {
      updateUI(user);
      loadAds();
      if (admins.includes(user?.email)) {
        logEvent("üë§ –ê–¥–º–∏–Ω –≤–æ—à—ë–ª: " + user.email);
      }
    });

    // –õ–æ–≥ –¥–ª—è –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
    function logEvent(text) {
      if (!admins.includes(currentUser?.email)) return;
      const time = new Date().toLocaleTimeString();
      logOutput.textContent += `[${time}] ${text}\n`;
      logOutput.scrollTop = logOutput.scrollHeight;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    async function loadAds() {
      adsList.innerHTML = "";
      try {
        let snapshot = await db.collection("ads").get();
        let ads = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (
            (!searchInput.value ||
              data.title.toLowerCase().includes(searchInput.value.toLowerCase()) ||
              data.description.toLowerCase().includes(searchInput.value.toLowerCase()) ||
              (data.category && data.category.toLowerCase().includes(searchInput.value.toLowerCase())))
          ) {
            ads.push({ id: doc.id, ...data });
          }
        });

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        if (sortSelect.value === "title") {
          ads.sort((a, b) => a.title.localeCompare(b.title));
        } else {
          ads.sort((a, b) => b.created?.seconds - a.created?.seconds);
        }

        ads.forEach(ad => renderAd(ad));
      } catch {
        showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π", "error");
      }
    }

    // –†–µ–Ω–¥–µ—Ä –æ–¥–Ω–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
    function renderAd(ad) {
      const div = document.createElement("div");
      div.className = "glass p-4 rounded-xl shadow-md dark:shadow-none";

      const dateStr = ad.created ? new Date(ad.created.seconds * 1000).toLocaleString() : "";

      div.innerHTML = `
        <h3 class="font-semibold text-xl mb-1">${escapeHtml(ad.title)}</h3>
        <p class="mb-2 whitespace-pre-line">${escapeHtml(ad.description)}</p>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${escapeHtml(ad.category || "–û–±—â–µ–µ")}</p>
        <p class="text-xs text-gray-400 mb-2">${dateStr}</p>
        <p class="text-sm mb-2">–ê–≤—Ç–æ—Ä: <strong>${escapeHtml(ad.author || "–ê–Ω–æ–Ω–∏–º")}</strong></p>
        ${ad.imageUrl ? `<img src="${ad.imageUrl}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è" class="max-w-full rounded mb-2" />` : ""}
        <button class="like-btn px-3 py-1 mr-2 rounded bg-pink-500 text-white hover:bg-pink-600 transition" data-id="${ad.id}">‚ù§Ô∏è –ù—Ä–∞–≤–∏—Ç—Å—è</button>
        ${currentUser && currentUser.email === ad.authorEmail || admins.includes(currentUser?.email) ? `
          <button class="edit-btn px-3 py-1 mr-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition" data-id="${ad.id}">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="delete-btn px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700 transition" data-id="${ad.id}">üóë –£–¥–∞–ª–∏—Ç—å</button>
        ` : ""}
        <ul id="comments-${ad.id}" class="mt-3 list-disc list-inside max-h-32 overflow-y-auto text-sm text-gray-700 dark:text-gray-300"></ul>
        ${currentUser ? `<input data-id="${ad.id}" class="comment-input w-full mt-2 p-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ –Ω–∞–∂–∞—Ç—å Enter" />` : `<p class="text-sm italic text-gray-500">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</p>`}
      `;
      adsList.appendChild(div);

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
      loadComments(ad.id);

      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ª–∞–π–∫–∞
      const likeBtn = div.querySelector(".like-btn");
      const likeKey = `likes_${ad.id}`;
      if (localStorage.getItem(likeKey)) {
        likeBtn.textContent = "üíñ –ü–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å";
      } else {
        likeBtn.textContent = "‚ù§Ô∏è –ù—Ä–∞–≤–∏—Ç—Å—è";
      }
    }

    // –õ–∞–π–∫ –∏ –∫–Ω–æ–ø–∫–∏
    adsList.addEventListener("click", e => {
      if (e.target.classList.contains("like-btn")) {
        const id = e.target.dataset.id;
        const key = `likes_${id}`;
        if (localStorage.getItem(key)) {
          localStorage.removeItem(key);
          e.target.textContent = "‚ù§Ô∏è –ù—Ä–∞–≤–∏—Ç—Å—è";
          showToast("–õ–∞–π–∫ —É–±—Ä–∞–Ω");
        } else {
          localStorage.setItem(key, "true");
          e.target.textContent = "üíñ –ü–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å";
          showToast("–õ–∞–π–∫ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω");
        }
      } else if (e.target.classList.contains("delete-btn")) {
        const id = e.target.dataset.id;
        if (confirm("–£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?")) {
          db.collection("ads").doc(id).delete()
            .then(() => {
              showToast("–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ", "success");
              logEvent(`üóë –û–±—ä—è–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ: ${id}`);
              loadAds();
            })
            .catch(() => showToast("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è", "error"));
        }
      } else if (e.target.classList.contains("edit-btn")) {
        const id = e.target.dataset.id;
        db.collection("ads").doc(id).get().then(doc => {
          if (doc.exists) {
            openEditModal({ id: doc.id, ...doc.data() });
          }
        });
      }
    });

    // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ Enter
    adsList.addEventListener("keydown", e => {
      if (e.target.classList.contains("comment-input") && e.key === "Enter") {
        e.preventDefault();
        const input = e.target;
        const id = input.dataset.id;
        const text = input.value.trim();
        if (!text) return;
        input.value = "";

        const commentData = {
          text,
          author: currentUser?.displayName || "–ê–Ω–æ–Ω–∏–º",
          created: firebase.firestore.FieldValue.serverTimestamp()
        };

        db.collection("ads").doc(id).collection("comments").add(commentData)
          .then(() => {
            showToast("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω", "success");
            logEvent(`üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—é ${id}`);
            loadComments(id);
          })
          .catch(() => showToast("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è", "error"));
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    async function loadComments(adId) {
      const commentsList = document.getElementById(`comments-${adId}`);
      if (!commentsList) return;
      commentsList.innerHTML = "";
      try {
        const snapshot = await db.collection("ads").doc(adId).collection("comments").orderBy("created", "desc").get();
        snapshot.forEach(doc => {
          const c = doc.data();
          const date = c.created ? new Date(c.created.seconds * 1000).toLocaleString() : "";
          const item = document.createElement("li");
          item.textContent = `${escapeHtml(c.author || "–ê–Ω–æ–Ω–∏–º")}: ${escapeHtml(c.text)} (${date})`;
          commentsList.appendChild(item);
        });
      } catch {
        commentsList.innerHTML = "<li>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</li>";
      }
    }

    // –ü–æ–∏—Å–∫ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    searchInput.addEventListener("input", () => loadAds());
    sortSelect.addEventListener("change", () => loadAds());

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –æ–±—ä—è–≤–ª–µ–Ω–∏—è
    adForm.addEventListener("submit", async e => {
      e.preventDefault();
      if (!currentUser) {
        showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è", "error");
        return;
      }

      const formData = new FormData(adForm);
      const title = formData.get("title").trim();
      const description = formData.get("description").trim();
      const author = formData.get("author").trim();
      const category = formData.get("category");
      const imageFile = document.getElementById("image").files[0];

      if (title.length < 3 || description.length < 5 || author.length < 1) {
        showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ", "error");
        return;
      }

      let imageUrl = "";
      if (imageFile) {
        try {
          const storageRef = storage.ref();
          const imgRef = storageRef.child(`ads_images/${Date.now()}_${imageFile.name}`);
          await imgRef.put(imageFile);
          imageUrl = await imgRef.getDownloadURL();
        } catch {
          showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", "error");
          return;
        }
      }

      const adData = {
        title,
        description,
        author,
        authorEmail: currentUser.email,
        category,
        created: firebase.firestore.FieldValue.serverTimestamp(),
        imageUrl,
      };

      try {
        await db.collection("ads").add(adData);
        showToast("–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ", "success");
        logEvent(`‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ: ${title}`);
        adForm.reset();
        loadAds();
      } catch {
        showToast("–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è", "error");
      }
    });

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/[&<>"']/g, m => {
        switch (m) {
          case "&":
            return "&amp;";
          case "<":
            return "&lt;";
          case ">":
            return "&gt;";
          case '"':
            return "&quot;";
          case "'":
            return "&#39;";
          default:
            return m;
        }
      });
    }
  </script>
</body>
</html>  
